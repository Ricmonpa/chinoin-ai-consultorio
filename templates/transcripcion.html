<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcriptor de Consultas - Chinoin AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <div class="header-content">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="CHINOIN Logo" class="logo">
            <div>
                <h1>Transcriptor de Consultas (IA)</h1>
                <p>Convierte el di√°logo en notas cl√≠nicas estructuradas</p>
            </div>
        </div>
    </header>
    <nav>
        <a href="/">Dashboard</a>
        <a href="/transcripcion" class="active">Transcriptor de Consultas (IA)</a>
        <a href="/asesoria">Asistente Legal/Contable</a>
    </nav>
    <main>
        <div class="card">
            <div class="legal-note">
                ‚ö†Ô∏è <strong>Aviso Legal:</strong> Confirme haber obtenido el <strong>Consentimiento Informado</strong> (verbal o escrito) del paciente para grabar la consulta con fines de documentaci√≥n m√©dica, seg√∫n NOM-004-SSA3-2012.
            </div>
            
            <h3>üìù Transcripci√≥n del Di√°logo de Consulta</h3>
            <p>Pegue aqu√≠ la transcripci√≥n completa de la conversaci√≥n entre m√©dico y paciente:</p>
            <textarea id="consulta_texto" rows="12" placeholder="Ejemplo:

M√©dico: Buenos d√≠as Sra. P√©rez, ¬øqu√© la trae por aqu√≠ hoy?
Paciente: Doctor, me duele mucho la garganta y tengo fiebre desde hace dos d√≠as. La temperatura lleg√≥ hasta 38.5 grados.
M√©dico: Entiendo. ¬øAlg√∫n otro s√≠ntoma? ¬øTos, dolor de cabeza?
Paciente: S√≠, me duele la cabeza y me siento muy cansada.
M√©dico: D√©jeme revisarla. Abra la boca por favor... Veo enrojecimiento en faringe sin placas. Los ganglios est√°n un poco inflamados. Temperatura actual 38.2¬∞C.
Paciente: ¬øEs algo grave doctor?
M√©dico: No se preocupe, parece una faringitis viral. Le voy a recetar paracetamol 500mg cada 8 horas por 3 d√≠as para la fiebre y el dolor. Muchos l√≠quidos y reposo. Si en 3 d√≠as no mejora, regrese.
Paciente: Perfecto doctor, muchas gracias."></textarea>
            
            <button class="button primary" onclick="procesarConsulta()" id="btnProcesar">
                <span id="btnTexto">ü§ñ Procesar con IA Gemini</span>
                <span id="btnLoading" class="hidden">‚è≥ Procesando...</span>
            </button>
        </div>

        <div id="resultados_ia" class="card hidden">
            <h3>‚úÖ Resultados del An√°lisis IA</h3>
            
            <div class="resultado-section">
                <h4>üìã 1. Notas Cl√≠nicas SOAP (Listas para copiar y pegar)</h4>
                <pre id="soap_output" class="soap-output"></pre>
                <button class="button secondary small" onclick="copiarTexto('soap_output')">üìã Copiar SOAP</button>
            </div>
            
            <div class="resultado-section">
                <h4>üîç 2. Informaci√≥n Cr√≠tica</h4>
                <div class="info-grid">
                    <div class="info-item">
                        <strong>Diagn√≥stico Sugerido:</strong>
                        <p id="diagnostico"></p>
                    </div>
                    <div class="info-item">
                        <strong>Plan de Tratamiento:</strong>
                        <p id="plan"></p>
                    </div>
                </div>
            </div>

            <div class="resultado-section">
                <h4>‚úì 3. Revisi√≥n de Cumplimiento M√©dico-Legal</h4>
                <p id="cumplimiento" class="cumplimiento-badge"></p>
            </div>
        </div>
    </main>

    <script>
        async function procesarConsulta() {
            const texto = document.getElementById('consulta_texto').value;
            if (!texto.trim()) {
                alert("Por favor, ingrese el texto de la consulta para procesar.");
                return;
            }

            const btnProcesar = document.getElementById('btnProcesar');
            const btnTexto = document.getElementById('btnTexto');
            const btnLoading = document.getElementById('btnLoading');
            
            btnProcesar.disabled = true;
            btnTexto.classList.add('hidden');
            btnLoading.classList.remove('hidden');

            try {
                const response = await fetch('/procesar_consulta', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ consulta_texto: texto })
                });

                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                document.getElementById('soap_output').textContent = data.soap_output;
                document.getElementById('diagnostico').textContent = data.diagnostico;
                document.getElementById('plan').textContent = data.plan;
                document.getElementById('cumplimiento').textContent = data.cumplimiento;
                
                document.getElementById('resultados_ia').classList.remove('hidden');
                document.getElementById('resultados_ia').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error:', error);
                alert('Ocurri√≥ un error al procesar la consulta. Por favor, intente nuevamente.');
            } finally {
                btnProcesar.disabled = false;
                btnTexto.classList.remove('hidden');
                btnLoading.classList.add('hidden');
            }
        }

        function copiarTexto(elementId) {
            const texto = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(texto).then(() => {
                alert('‚úÖ Texto copiado al portapapeles');
            }).catch(err => {
                console.error('Error al copiar:', err);
            });
        }
    </script>
    <footer>
        <p>&copy; 2025 CHINOIN¬Æ - Kit de herramientas gratuito para m√©dicos | Powered by Gemini AI</p>
    </footer>
</body>
</html>
