<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcriptor de Consultas - Chinoin AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .recorder-container {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #fff5f2 0%, #ffffff 100%);
            border-radius: 12px;
            margin: 20px 0;
        }
        .recorder-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            font-size: 3em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .recorder-button:hover {
            transform: scale(1.05);
        }
        .recorder-button.recording {
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            animation: pulse 1.5s infinite;
        }
        .recorder-button.ready {
            background: linear-gradient(135deg, #FF6B4A 0%, #ff8566 100%);
            color: white;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            50% { box-shadow: 0 0 0 20px rgba(255, 0, 0, 0); }
        }
        .recorder-status {
            margin-top: 20px;
            font-size: 1.2em;
            font-weight: bold;
            color: #FF6B4A;
        }
        .recorder-timer {
            font-size: 2em;
            font-weight: bold;
            color: #1a1a1a;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }
        .audio-visualizer {
            margin: 20px auto;
            width: 100%;
            max-width: 600px;
            height: 100px;
            background: #2d2d2d;
            border-radius: 8px;
            display: none;
        }
        .audio-visualizer.active {
            display: block;
        }
        .transcript-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #FF6B4A;
            display: none;
        }
        .transcript-preview.active {
            display: block;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="CHINOIN Logo" class="logo">
            <div>
                <h1>Transcriptor de Consultas (IA)</h1>
                <p>Graba la consulta y obt√©n notas cl√≠nicas autom√°ticamente</p>
            </div>
        </div>
    </header>
    <nav>
        <a href="/">Dashboard</a>
        <a href="/transcripcion" class="active">Transcriptor de Consultas (IA)</a>
        <a href="/historial">Historial</a>
        <a href="/asesoria">Asistente Legal/Contable</a>
    </nav>
    <main>
        <div class="card">
            <div class="legal-note">
                ‚ö†Ô∏è <strong>Aviso Legal:</strong> Confirme haber obtenido el <strong>Consentimiento Informado</strong> (verbal o escrito) del paciente para grabar la consulta con fines de documentaci√≥n m√©dica, seg√∫n NOM-004-SSA3-2012.
            </div>
            
            <h3>üé§ Grabaci√≥n de Consulta M√©dica</h3>
            <p><strong>Instrucciones:</strong> Haga clic en el bot√≥n para iniciar la grabaci√≥n de la consulta. La IA transcribir√° autom√°ticamente el audio y generar√° las notas SOAP.</p>
            
            <div style="margin: 15px 0;">
                <label for="pacienteNombre" style="display: block; margin-bottom: 5px; font-weight: bold;">
                    üë§ Nombre del Paciente (Opcional):
                </label>
                <input type="text" id="pacienteNombre" placeholder="Ej: Juan P√©rez" 
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
            </div>
            
            <div class="recorder-container">
                <button id="recordButton" class="recorder-button ready" onclick="toggleRecording()">
                    üé§
                </button>
                <div class="recorder-timer" id="timer">00:00</div>
                <div class="recorder-status" id="status">Listo para grabar</div>
                <canvas id="visualizer" class="audio-visualizer"></canvas>
            </div>

            <div id="transcriptPreview" class="transcript-preview">
                <h4>üìù Transcripci√≥n en progreso...</h4>
                <p id="transcriptText">Procesando audio...</p>
            </div>
        </div>

        <div id="resultados_ia" class="card hidden">
            <h3>‚úÖ Resultados del An√°lisis IA</h3>
            
            <div class="resultado-section">
                <h4>üìÑ Transcripci√≥n Completa</h4>
                <pre id="transcript_output" class="soap-output" style="color: #ffffff;"></pre>
                <button class="button secondary small" onclick="copiarTexto('transcript_output')">üìã Copiar Transcripci√≥n</button>
            </div>
            
            <div class="resultado-section">
                <h4>üìã Notas Cl√≠nicas SOAP (Listas para copiar)</h4>
                <pre id="soap_output" class="soap-output"></pre>
                <button class="button secondary small" onclick="copiarTexto('soap_output')">üìã Copiar SOAP</button>
            </div>
            
            <div class="resultado-section">
                <h4>üîç Informaci√≥n Cr√≠tica</h4>
                <div class="info-grid">
                    <div class="info-item">
                        <strong>Diagn√≥stico Sugerido:</strong>
                        <p id="diagnostico"></p>
                    </div>
                    <div class="info-item">
                        <strong>Plan de Tratamiento:</strong>
                        <p id="plan"></p>
                    </div>
                </div>
            </div>

            <div class="resultado-section">
                <h4>‚úì Revisi√≥n de Cumplimiento M√©dico-Legal</h4>
                <p id="cumplimiento" class="cumplimiento-badge"></p>
            </div>
        </div>
    </main>

    <script>
        // LOG INMEDIATO AL CARGAR
        console.log('üöÄ CHINOIN AI - Transcriptor cargado correctamente');
        console.log('Timestamp:', new Date().toISOString());
        
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let startTime;
        let timerInterval;
        let audioContext;
        let analyser;
        let dataArray;
        let animationId;

        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.addEventListener('dataavailable', event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener('stop', async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await processAudio(audioBlob);
                });

                setupVisualizer(stream);
                
                mediaRecorder.start();
                isRecording = true;
                
                document.getElementById('recordButton').classList.remove('ready');
                document.getElementById('recordButton').classList.add('recording');
                document.getElementById('recordButton').textContent = '‚èπÔ∏è';
                document.getElementById('status').textContent = 'üî¥ Grabando...';
                
                startTime = Date.now();
                timerInterval = setInterval(updateTimer, 1000);
                
            } catch (error) {
                console.error('Error al acceder al micr√≥fono:', error);
                alert('Error: No se pudo acceder al micr√≥fono. Por favor, permita el acceso al micr√≥fono en su navegador.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                
                clearInterval(timerInterval);
                cancelAnimationFrame(animationId);
                
                document.getElementById('recordButton').classList.remove('recording');
                document.getElementById('recordButton').classList.add('ready');
                document.getElementById('recordButton').textContent = 'üé§';
                document.getElementById('status').textContent = 'Procesando audio...';
                document.getElementById('visualizer').classList.remove('active');
            }
        }

        function setupVisualizer(stream) {
            const canvas = document.getElementById('visualizer');
            canvas.classList.add('active');
            const canvasCtx = canvas.getContext('2d');
            
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            
            canvas.width = canvas.offsetWidth;
            canvas.height = 100;
            
            function draw() {
                animationId = requestAnimationFrame(draw);
                
                analyser.getByteFrequencyData(dataArray);
                
                canvasCtx.fillStyle = '#2d2d2d';
                canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
                
                const barWidth = (canvas.width / bufferLength) * 2.5;
                let barHeight;
                let x = 0;
                
                for (let i = 0; i < bufferLength; i++) {
                    barHeight = (dataArray[i] / 255) * canvas.height;
                    
                    canvasCtx.fillStyle = `rgb(${255 - dataArray[i]}, ${107 + dataArray[i] / 2}, 74)`;
                    canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    
                    x += barWidth + 1;
                }
            }
            
            draw();
        }

        function updateTimer() {
            const elapsed = Date.now() - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('timer').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        async function processAudio(audioBlob) {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'consulta.webm');
            
            // Agregar nombre del paciente si est√° disponible
            const pacienteNombre = document.getElementById('pacienteNombre').value.trim();
            if (pacienteNombre) {
                formData.append('paciente_nombre', pacienteNombre);
            }
            
            document.getElementById('transcriptPreview').classList.add('active');
            document.getElementById('transcriptText').textContent = 'Transcribiendo audio con IA...';

            try {
                const response = await fetch('/api/transcribir_audio', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                // LOGS PARA DEBUG EN CELULAR
                console.log('=== RESPUESTA COMPLETA DE LA API ===');
                console.log('Status:', response.status);
                console.log('Data completa:', data);
                console.log('Debug info:', data.debug);
                console.log('Raw AI Response:', data.debug?.raw_ai_response);
                console.log('SOAP Output:', data.soap_output);
                console.log('=====================================');
                
                if (data.error) {
                    console.error('ERROR:', data.error);
                    alert('Error: ' + data.error);
                    document.getElementById('status').textContent = 'Error al procesar';
                    return;
                }
                
                document.getElementById('transcript_output').textContent = data.transcription || 'No se pudo transcribir';
                document.getElementById('soap_output').textContent = data.soap_output;
                document.getElementById('diagnostico').textContent = data.diagnostico;
                document.getElementById('plan').textContent = data.plan;
                document.getElementById('cumplimiento').textContent = data.cumplimiento;
                
                // Mostrar debug info si existe
                if (data.debug) {
                    console.log('=== DEBUG INFO ===');
                    console.log('Raw AI Response:', data.debug.raw_ai_response);
                    console.log('Response Length:', data.debug.response_length);
                    console.log('Transcription Length:', data.debug.transcription_length);
                    
                    // Mostrar en la UI tambi√©n
                    const debugDiv = document.createElement('div');
                    debugDiv.style.cssText = 'background:#ffe; border:2px solid #fa0; padding:15px; margin:20px 0; border-radius:8px; font-family:monospace; font-size:12px;';
                    debugDiv.innerHTML = `
                        <strong style="color:#f60;">üêõ DEBUG INFO:</strong><br>
                        <strong>Raw AI Response (first 800 chars):</strong><br>
                        <pre style="white-space:pre-wrap; background:#fff; padding:10px; border-radius:4px; max-height:200px; overflow-y:auto;">${data.debug.raw_ai_response}</pre>
                        <strong>Response Length:</strong> ${data.debug.response_length} chars<br>
                        <strong>Transcription Length:</strong> ${data.debug.transcription_length} chars
                    `;
                    document.getElementById('resultados_ia').prepend(debugDiv);
                }
                
                document.getElementById('resultados_ia').classList.remove('hidden');
                document.getElementById('status').textContent = '‚úÖ Completado';
                document.getElementById('timer').textContent = '00:00';
                document.getElementById('transcriptPreview').classList.remove('active');
                document.getElementById('resultados_ia').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error:', error);
                alert('Ocurri√≥ un error al procesar el audio. Por favor, intente nuevamente.');
                document.getElementById('status').textContent = 'Error - Intente nuevamente';
                document.getElementById('timer').textContent = '00:00';
            }
        }

        function copiarTexto(elementId) {
            const texto = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(texto).then(() => {
                alert('‚úÖ Texto copiado al portapapeles');
            }).catch(err => {
                console.error('Error al copiar:', err);
            });
        }
    </script>
    <footer>
        <p>&copy; 2025 CHINOIN¬Æ - Kit de herramientas gratuito para m√©dicos | Powered by Gemini AI</p>
    </footer>
</body>
</html>
